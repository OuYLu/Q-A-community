<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community.mapper.NotifyMessageMapper">
  <select id="selectAppNotifications" resultType="com.community.vo.AppNotificationItemVO">
    SELECT
      id,
      type,
      biz_type AS bizType,
      biz_id AS bizId,
      title,
      content,
      is_read AS isRead,
      created_at AS createdAt
    FROM notify_message
    WHERE receiver_id = #{userId}
    <if test="type != null">
      AND type = #{type}
    </if>
    <if test="isRead != null">
      AND is_read = #{isRead}
    </if>
    ORDER BY created_at DESC, id DESC
  </select>

  <select id="selectUnreadCountByType" resultType="com.community.vo.AppNotificationTypeCountVO">
    SELECT type, COUNT(1) AS cnt
    FROM notify_message
    WHERE receiver_id = #{userId}
      AND is_read = 0
    GROUP BY type
  </select>

  <update id="updateReadById">
    UPDATE notify_message
    SET is_read = 1,
        read_at = #{readAt}
    WHERE id = #{id}
      AND receiver_id = #{userId}
      AND is_read = 0
  </update>

  <update id="updateReadAll">
    UPDATE notify_message
    SET is_read = 1,
        read_at = #{readAt}
    WHERE receiver_id = #{userId}
      AND is_read = 0
  </update>
</mapper>
