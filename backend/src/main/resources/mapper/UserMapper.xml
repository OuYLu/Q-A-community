<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community.mapper.UserMapper">
  <select id="selectRoleCodesByUserId" resultType="string">
    SELECT r.code
    FROM user_role ur
    JOIN role r ON ur.role_id = r.id
    WHERE ur.user_id = #{userId}
  </select>

  <select id="selectByUsernameOrPhone" resultType="com.community.entity.User">
    SELECT *
    FROM user
    WHERE username = #{value} OR phone = #{value}
    LIMIT 1
  </select>

  <select id="selectPermCodesByUserId" resultType="string">
    SELECT DISTINCT p.code
    FROM user_role ur
    JOIN role_permission rp ON ur.role_id = rp.role_id
    JOIN permission p ON rp.permission_id = p.id
    WHERE ur.user_id = #{userId}
  </select>

  <select id="selectManageableUsers" resultType="com.community.entity.User">
    SELECT DISTINCT u.*
    FROM user u
    JOIN user_role ur ON u.id = ur.user_id
    JOIN role r ON ur.role_id = r.id
    WHERE r.code IN ('staff','customer','expert')
      AND u.id NOT IN (
        SELECT ur2.user_id
        FROM user_role ur2
        JOIN role r2 ON ur2.role_id = r2.id
        WHERE r2.code = 'admin'
      )
    <if test="username != null and username != ''">
      AND u.username LIKE CONCAT('%', #{username}, '%')
    </if>
    <if test="nickname != null and nickname != ''">
      AND u.nickname LIKE CONCAT('%', #{nickname}, '%')
    </if>
    <if test="status != null">
      AND u.status = #{status}
    </if>
    <if test="roleCode != null and roleCode != ''">
      AND r.code = #{roleCode}
    </if>
    ORDER BY u.created_at DESC
  </select>
</mapper>
