<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community.mapper.QaTopicMapper">
  <select id="selectAdminTopicPage" resultType="com.community.vo.AdminTopicListItemVO">
    SELECT
      t.id,
      t.title,
      t.subtitle,
      t.cover_img AS coverImg,
      t.status,
      t.follow_count AS followCount,
      t.question_count AS questionCount,
      t.today_new_count AS todayNewCount,
      COALESCE(tc.category_count, 0) AS categoryCount,
      t.created_by AS createdBy,
      t.created_at AS createdAt,
      t.updated_at AS updatedAt
    FROM qa_topic t
    LEFT JOIN (
      SELECT topic_id, COUNT(1) AS category_count
      FROM qa_topic_category
      GROUP BY topic_id
    ) tc ON tc.topic_id = t.id
    WHERE 1 = 1
    <if test="title != null and title != ''">
      AND t.title LIKE CONCAT('%', #{title}, '%')
    </if>
    <if test="status != null">
      AND t.status = #{status}
    </if>
    <if test="createdBy != null">
      AND t.created_by = #{createdBy}
    </if>
    <if test="dateStart != null">
      AND DATE(t.created_at) &gt;= #{dateStart}
    </if>
    <if test="dateEnd != null">
      AND DATE(t.created_at) &lt;= #{dateEnd}
    </if>
    ORDER BY
      <choose>
        <when test="sortBy == 'followCount'">t.follow_count</when>
        <when test="sortBy == 'questionCount'">t.question_count</when>
        <when test="sortBy == 'todayNewCount'">t.today_new_count</when>
        <otherwise>t.created_at</otherwise>
      </choose>
      <choose>
        <when test="sortOrder == 'asc'">ASC</when>
        <otherwise>DESC</otherwise>
      </choose>,
      t.id DESC
  </select>

  <select id="selectRecentQuestionsByTopicId" resultType="com.community.vo.TopicRecentQuestionVO">
    SELECT
      q.id,
      q.title,
      q.status,
      q.created_at AS createdAt,
      q.user_id AS userId,
      u.nickname AS authorName
    FROM qa_question q
    LEFT JOIN user u ON u.id = q.user_id
    WHERE q.topic_id = #{topicId}
      AND q.delete_flag = 0
    ORDER BY q.created_at DESC, q.id DESC
    LIMIT #{limit}
  </select>

  <select id="selectTopicQuestionPage" resultType="com.community.vo.TopicQuestionPageItemVO">
    SELECT
      q.id,
      q.title,
      q.status,
      q.created_at AS createdAt,
      q.user_id AS userId
    FROM qa_question q
    WHERE q.topic_id = #{topicId}
      AND q.delete_flag = 0
    <if test="status != null">
      AND q.status = #{status}
    </if>
    <if test="title != null and title != ''">
      AND q.title LIKE CONCAT('%', #{title}, '%')
    </if>
    ORDER BY
      <choose>
        <when test="sortBy == 'createdAt'">q.created_at</when>
        <when test="sortBy == 'viewCount'">q.view_count</when>
        <when test="sortBy == 'answerCount'">q.answer_count</when>
        <otherwise>q.created_at</otherwise>
      </choose>
      <choose>
        <when test="sortOrder == 'asc'">ASC</when>
        <otherwise>DESC</otherwise>
      </choose>,
      q.id DESC
  </select>

  <select id="selectTopicTrend" resultType="com.community.vo.TopicTrendPointVO">
    WITH RECURSIVE date_series AS (
      SELECT DATE_SUB(CURDATE(), INTERVAL #{daysMinusOne} DAY) AS d
      UNION ALL
      SELECT DATE_ADD(d, INTERVAL 1 DAY)
      FROM date_series
      WHERE d &lt; CURDATE()
    ),
    stat AS (
      SELECT DATE(q.created_at) AS d, COUNT(1) AS cnt
      FROM qa_question q
      WHERE q.topic_id = #{topicId}
        AND q.delete_flag = 0
        AND q.created_at &gt;= DATE_SUB(CURDATE(), INTERVAL #{daysMinusOne} DAY)
        AND q.created_at &lt; DATE_ADD(CURDATE(), INTERVAL 1 DAY)
      GROUP BY DATE(q.created_at)
    )
    SELECT
      DATE_FORMAT(ds.d, '%Y-%m-%d') AS date,
      COALESCE(s.cnt, 0) AS cnt
    FROM date_series ds
    LEFT JOIN stat s ON s.d = ds.d
    ORDER BY ds.d ASC
  </select>

  <select id="selectAppTopicPage" resultType="com.community.vo.AppTopicListItemVO">
    SELECT
      t.id,
      t.title,
      t.subtitle,
      t.cover_img AS coverImg,
      t.follow_count AS followCount,
      t.question_count AS questionCount,
      t.today_new_count AS todayNewCount
    FROM qa_topic t
    WHERE t.status = 1
    <if test="keyword != null and keyword != ''">
      AND t.title LIKE CONCAT('%', #{keyword}, '%')
    </if>
    ORDER BY
      <choose>
        <when test="sortBy == 'questionCount'">t.question_count</when>
        <when test="sortBy == 'todayNewCount'">t.today_new_count</when>
        <when test="sortBy == 'createdAt'">t.created_at</when>
        <otherwise>t.follow_count</otherwise>
      </choose>
      <choose>
        <when test="sortOrder == 'asc'">ASC</when>
        <otherwise>DESC</otherwise>
      </choose>,
      t.id DESC
  </select>

  <select id="selectAppHotTopics" resultType="com.community.vo.AppTopicListItemVO">
    SELECT
      t.id,
      t.title,
      t.subtitle,
      t.cover_img AS coverImg,
      t.follow_count AS followCount,
      t.question_count AS questionCount,
      t.today_new_count AS todayNewCount
    FROM qa_topic t
    WHERE t.status = 1
    ORDER BY t.follow_count DESC, t.question_count DESC, t.created_at DESC
    LIMIT #{limit}
  </select>

  <select id="selectAppSearchTopics" resultType="com.community.vo.AppSearchTopicVO">
    SELECT
      t.id,
      t.title,
      t.subtitle,
      t.cover_img AS coverImg,
      t.follow_count AS followCount,
      t.question_count AS questionCount
    FROM qa_topic t
    WHERE t.status = 1
      AND (t.title LIKE CONCAT('%', #{query}, '%')
        OR t.subtitle LIKE CONCAT('%', #{query}, '%'))
    ORDER BY t.follow_count DESC, t.question_count DESC, t.created_at DESC
    LIMIT #{limit}
  </select>

  <update id="updateFollowCount">
    UPDATE qa_topic
    SET follow_count = CASE
      WHEN follow_count + #{delta} &lt; 0 THEN 0
      ELSE follow_count + #{delta}
    END
    WHERE id = #{id}
  </update>
</mapper>
